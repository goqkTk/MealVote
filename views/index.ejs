<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MealVote</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/main.css" rel="stylesheet">
    <!-- Socket.IO 클라이언트 -->
    <script src="/socket.io/socket.io.js"></script>
    <link rel="manifest" href="/manifest.json">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand">MealVote</a>
            <div class="d-flex align-items-center">
                <span class="me-3" style="cursor: pointer;" onclick="showSettingsModal()">
                    <i class="fas fa-user"></i>
                    <span id="userName"></span>
                </span>
                <button id="logoutButton" class="btn btn-outline-secondary btn-sm" onclick="logout()">로그아웃</button>
            </div>
        </div>
    </nav>

    <!-- 알림 구독 섹션 (로그인 사용자에게만 표시) -->
    

    <div class="container">
        <!-- 선생님용 액션 버튼 -->
        <div class="teacher-actions mb-4">
            <button class="btn btn-primary me-2" onclick="showAddRestaurantModal()">
                <i class="fas fa-plus me-2"></i>가게 추가
            </button>
            <button class="btn btn-primary" onclick="showCreateVoteModal()">
                <i class="fas fa-vote-yea me-2"></i>투표 생성
            </button>
        </div>

        <!-- 선생님용 가게 목록 -->
        <div class="teacher-actions mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-store me-2"></i>가게 목록
                    </h5>
                    <div id="restaurantList" class="row">
                        <!-- 가게 목록이 여기에 동적으로 추가됩니다 -->
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-vote-yea me-2"></i>현재 진행 중인 투표
                        </h5>
                        <div id="currentVote">
                            <!-- 현재 진행 중인 투표가 여기에 표시됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-history me-2"></i>투표 기록
                            </span>
                            <button class="btn btn-link btn-sm text-dark" onclick="showAllVoteHistory()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </h5>
                        <div id="voteHistory">
                            <!-- 투표 기록이 여기에 표시됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 가게 추가/수정 모달 -->
    <div class="modal fade" id="restaurantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="restaurantModalTitle">가게 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="restaurantForm">
                        <input type="hidden" name="restaurantId">
                        <div class="mb-3">
                            <label class="form-label">가게 이름 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">설명</label>
                            <textarea class="form-control" name="description" rows="3" style="resize: none;"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">메뉴 <span class="text-danger">*</span></label>
                            <div id="menuList">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" name="menuNames[]" placeholder="메뉴 이름" required>
                                    <input type="number" class="form-control" name="menuPrices[]" placeholder="가격" required>
                                    <button type="button" class="btn btn-danger" onclick="removeMenu(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addMenuField()">
                                <i class="fas fa-plus me-2"></i>메뉴 추가
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="submitRestaurant()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 투표 생성 모달 -->
    <div class="modal fade" id="createVoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">투표 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createVoteForm">
                        <div class="mb-3">
                            <label class="form-label">투표 제목 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">가게 선택 <span class="text-danger">*</span></label>
                            <select class="form-select" name="restaurantId" required onchange="loadRestaurantMenus(this.value)">
                                <option value="">가게를 선택하세요</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">투표할 메뉴 선택 <span class="text-danger">*</span></label>
                            <div id="menuSelection" class="row">
                                <!-- 메뉴 카드들이 여기에 동적으로 추가됩니다 -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">투표 마감 시간 <span class="text-danger">*</span></label>
                            <input type="datetime-local" name="endTime" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="submitVote()">생성</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 커스텀 달력 모달 -->
    <div class="modal fade" id="datePickerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">날짜 선택</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="calendar">
                        <div class="calendar-header">
                            <button class="btn btn-link" onclick="prevMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="current-month"></span>
                            <button class="btn btn-link" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-weekdays">
                            <div>일</div>
                            <div>월</div>
                            <div>화</div>
                            <div>수</div>
                            <div>목</div>
                            <div>금</div>
                            <div>토</div>
                        </div>
                        <div class="calendar-days"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 전체 투표 기록 모달 -->
    <div class="modal fade" id="allVoteHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">전체 투표 기록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="allVoteHistoryList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 투표자 목록 모달 -->
    <div class="modal fade" id="votersModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="votersModalTitle">투표자 목록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="votersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 설정 모달 -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">설정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 알림 설정 섹션 -->
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <div>
                            <div class="d-flex align-items-center">
                                <label class="form-check-label me-1" for="notificationToggle">푸시 알림</label>
                                <i class="fas fa-question-circle" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#notificationHelpModal"></i>
                            </div>
                            <small class="text-muted d-block">투표 생성 시 알림 수신 설정</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div id="notificationLoading" class="me-2" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">로딩중...</span>
                                </div>
                            </div>
                             <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="notificationToggle">
                            </div>
                        </div>
                    </div>

                    <!-- 투표 관련 설정 섹션 -->
                    <div class="mb-3 pb-3 border-bottom">
                        <h6>투표 관련 설정</h6>
                        <div class="mb-3">
                            <label for="voteHistoryCount" class="form-label mb-0">투표 기록 표시 개수</label>
                            <small class="text-muted d-block">메인 화면에 표시될 투표 기록의 개수를 설정합니다 (0-20, 기본값: 2).</small>
                            <input type="number" class="form-control form-control-sm mt-2" id="voteHistoryCount" value="2" min="0" max="20">
                        </div>
                        <!-- 추가 투표 관련 설정 옵션들이 여기에 들어갈 수 있습니다. -->
                    </div>

                    <!-- 계정 설정 섹션 -->
                    <div class="mb-0 pt-2">
                         <h6 class="mb-3">계정</h6>
                        
                         <!-- 비밀번호 변경 항목 -->
                         <div class="d-flex justify-content-between align-items-center mb-3">
                             <div>
                                 <label class="form-label mb-0">비밀번호 변경</label>
                                 <small class="text-muted d-block">계정 비밀번호를 변경합니다.</small>
                             </div>
                             <button class="btn btn-outline-secondary btn-sm" type="button" id="togglePasswordChangeForm">
                                 변경
                             </button>
                         </div>
                        
                        <!-- 비밀번호 변경 폼 (초기에 숨김) -->
                        <div id="passwordChangeFormContainer" class="d-none card card-body bg-light mb-3">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label visually-hidden">현재 비밀번호</label>
                                    <input type="password" class="form-control form-control-sm" id="currentPassword" placeholder="현재 비밀번호" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label visually-hidden">새 비밀번호</label>
                                    <input type="password" class="form-control form-control-sm" id="newPassword" placeholder="새 비밀번호" required>
                                </div>
                                <div class="mb-3">
                                     <label for="confirmPassword" class="form-label visually-hidden">새 비밀번호 확인</label>
                                    <input type="password" class="form-control form-control-sm" id="confirmPassword" placeholder="새 비밀번호 확인" required>
                                </div>
                                <div id="passwordChangeError" class="alert alert-danger alert-sm d-none" role="alert"></div>
                                <div id="passwordChangeSuccess" class="alert alert-success alert-sm d-none" role="alert"></div>
                                <button type="submit" class="btn btn-primary d-block mx-auto btn-sm">
                                    변경하기
                                </button>
                            </form>
                        </div>

                         <!-- 프로필 이미지, 이름, 이메일 변경 등의 항목이 여기에 추가될 수 있습니다. -->
                         <!-- 예시: 프로필 이미지 변경 -->
                         <!--
                         <div class="d-flex justify-content-between align-items-center mb-3">
                              <div>
                                  <label class="form-label mb-0">프로필 이미지</label>
                                  <small class="text-muted d-block">프로필 이미지를 변경합니다.</small>
                              </div>
                             <button class="btn btn-outline-secondary btn-sm">변경</button>
                         </div>
                         -->
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- 푸시 알림 도움말 모달 -->
    <div class="modal fade" id="notificationHelpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">푸시 알림 설정 가이드</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="notificationHelpTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="desktop-tab" data-bs-toggle="tab" data-bs-target="#desktop" type="button" role="tab">데스크탑</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="android-tab" data-bs-toggle="tab" data-bs-target="#android" type="button" role="tab">안드로이드</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ios-tab" data-bs-toggle="tab" data-bs-target="#ios" type="button" role="tab">iOS</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="notificationHelpTabContent">
                        <div class="tab-pane fade show active" id="desktop" role="tabpanel">
                            <h6>데스크탑 브라우저 설정 방법</h6>
                            <ol class="mb-0">
                                <li>브라우저 상단의 주소창 왼쪽에 있는 자물쇠/정보 아이콘을 클릭합니다.</li>
                                <li>알림 권한을 '허용'으로 설정합니다.</li>
                                <li>설정 모달에서 푸시 알림 토글을 켜기로 설정합니다.</li>
                            </ol>
                        </div>
                        <div class="tab-pane fade" id="android" role="tabpanel">
                            <h6>안드로이드 설정 방법</h6>
                            <ol class="mb-0">
                                <li>Chrome 브라우저를 실행합니다.</li>
                                <li>주소창에 'chrome://settings/content/notifications'를 입력합니다.</li>
                                <li>MealVote 사이트를 찾아 알림을 '허용'으로 설정합니다.</li>
                                <li>설정 모달에서 푸시 알림 토글을 켜기로 설정합니다.</li>
                            </ol>
                        </div>
                        <div class="tab-pane fade" id="ios" role="tabpanel">
                            <h6>iOS 설정 방법</h6>
                            <ol class="mb-0">
                                <li>Safari 브라우저를 실행합니다.</li>
                                <li>설정 앱을 열고 Safari를 선택합니다.</li>
                                <li>'알림'을 찾아 MealVote 사이트의 알림을 허용합니다.</li>
                                <li>설정 모달에서 푸시 알림 토글을 켜기로 설정합니다.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/js/auth.js"></script>
    <script src="/js/vote.js"></script>
</body>
</html> 